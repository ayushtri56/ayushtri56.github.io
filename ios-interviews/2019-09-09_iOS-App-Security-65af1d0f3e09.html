<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>iOS App Security</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">iOS App Security</h1>
</header>
<section data-field="subtitle" class="p-summary">
Tampering and Reverse Engineering
</section>
<section data-field="body" class="e-content">
<section name="70d8" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="6943" id="6943" class="graf graf--h3 graf--leading graf--title"><strong class="markup--strong markup--h3-strong">iOS App Security</strong></h3><p name="59d9" id="59d9" class="graf graf--p graf-after--h3"><strong class="markup--strong markup--p-strong">Tampering and Reverse Engineering</strong></p><figure name="e201" id="e201" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*2yEO-DuTvAaTzwhfRJCl6Q.png" data-width="606" data-height="390" src="https://cdn-images-1.medium.com/max/800/1*2yEO-DuTvAaTzwhfRJCl6Q.png"></figure><p name="74eb" id="74eb" class="graf graf--p graf-after--figure">This article considers key areas in mobile app security and popular anti-reverse engineering protection techniques. There are several approaches to analyzing software:</p><ol class="postList"><li name="c2a2" id="c2a2" class="graf graf--li graf-after--p">Data exchange analysis using a packet sniffer to analyze data exchanged over a network.</li><li name="4f92" id="4f92" class="graf graf--li graf-after--li">Software binary code disassembly to get its listing in assembly language.</li><li name="4bbe" id="4bbe" class="graf graf--li graf-after--li">Decompilation of binary or byte-code to recreate source code in a high-level programming language.</li></ol><p name="95d8" id="95d8" class="graf graf--p graf-after--li">Let’s start with understanding few basic terms used through out the article.</p><p name="e58b" id="e58b" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Data tampering</strong> is the act of deliberately modifying (destroying, manipulating, or editing) data through unauthorized channels. Data exists in two states: in transit or at rest. In both instances, data could be intercepted and tampered with. Digital communications are all about data transmission.</p><p name="4b02" id="4b02" class="graf graf--p graf-after--p">For example, in the instances where data packets are transmitted unprotected, a hacker can intercept the data packet, modify its contents, and change its destination address. With data at rest, a system application can suffer a security breach and an unauthorized intruder could deploy malicious code that corrupts the data or underlying programming code. In both instances, the intrusion is malicious and the effects on the data always dire. It’s one of the biggest security threats that any application, program, or organization can face.</p><p name="ac57" id="ac57" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Reverse engineering</strong> a mobile app is the process of analyzing the compiled app to extract information about its source code. The goal of reverse engineering is <em class="markup--em markup--p-em">comprehending</em> the code.</p><h3 name="db87" id="db87" class="graf graf--h3 graf-after--p">Key Areas in Mobile Application Security</h3><ol class="postList"><li name="c5fa" id="c5fa" class="graf graf--li graf-after--h3"><strong class="markup--strong markup--li-strong">Local Data Storage</strong></li></ol><p name="19e7" id="19e7" class="graf graf--p graf-after--li">The protection of sensitive data, such as user credentials and private information, is crucial to mobile security. If an app uses operating system APIs such as local storage or inter-process communication (IPC) improperly, the app might expose sensitive data to other apps running on the same device. It may also unintentionally leak data to cloud storage, backups, or the keyboard cache. Additionally, mobile devices can be lost or stolen more easily compared to other types of devices, so it’s more likely an individual can gain physical access to the device, making it easier to retrieve the data.</p><p name="76b2" id="76b2" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">2. Communication with Trusted Endpoints</strong></p><p name="8058" id="8058" class="graf graf--p graf-after--p">Mobile devices regularly connect to a variety of networks, including public WiFi networks shared with other (potentially malicious) clients. This creates opportunities for a wide variety of network-based attacks ranging from simple to complicated and old to new. It’s crucial to maintain the confidentiality and integrity of information exchanged between the mobile app and remote service endpoints. As a basic requirement, mobile apps must set up a secure, encrypted channel for network communication using the TLS protocol with appropriate settings.</p><p name="a30f" id="a30f" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">3. Code Quality and Exploit Mitigation</strong></p><p name="2551" id="2551" class="graf graf--p graf-after--p">Traditional injection and memory management issues aren’t often seen in mobile apps due to the smaller attack surface. Mobile apps mostly interact with the trusted backend service and the UI, so even if many buffer overflow vulnerabilities exist in the app, those vulnerabilities usually don’t open up any useful attack vectors.</p><p name="ce33" id="ce33" class="graf graf--p graf-after--p">This protection from injection and memory management issues doesn’t mean that app developers can get away with writing sloppy code. Following security best practices results in hardened (secure) release builds that are resilient against tampering. Free security features offered by compilers and mobile SDKs help increase security and mitigate attacks.</p><p name="ec10" id="ec10" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">4. Anti-Tampering and Anti-Reversing</strong></p><p name="b803" id="b803" class="graf graf--p graf-after--p">There are three things you should never bring up in polite conversations: religion, politics, and code obfuscation. Many security experts dismiss client-side protections outright. However, software protection controls are widely used in the mobile app world, so security testers need ways to deal with these protections. We believe there’s a benefit to client-side protections if they are employed with a clear purpose and realistic expectations in mind and aren’t used to replace security controls.</p><h3 name="bfc3" id="bfc3" class="graf graf--h3 graf-after--p">iOS Application Attack surface</h3><p name="14f4" id="14f4" class="graf graf--p graf-after--h3">The iOS application attack surface consists of all components of the application, including the supportive material necessary to release the app and to support its functioning. The iOS application may be vulnerable to attack if it does not:</p><ol class="postList"><li name="5ae3" id="5ae3" class="graf graf--li graf-after--p">Validate all input by means of IPC communication or URL schemes, see also:</li></ol><ul class="postList"><li name="78cf" id="78cf" class="graf graf--li graf-after--li"><a href="https://developer.apple.com/library/archive/documentation/Security/Conceptual/SecureCodingGuide/Articles/ValidatingInput.html" data-href="https://developer.apple.com/library/archive/documentation/Security/Conceptual/SecureCodingGuide/Articles/ValidatingInput.html" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Testing Custom URL Schemes</a></li></ul><p name="5829" id="5829" class="graf graf--p graf-after--li">2. Validate all input by the user in input fields.</p><p name="d10e" id="d10e" class="graf graf--p graf-after--p">3. Validate the content loaded inside a WebView, see also:</p><ul class="postList"><li name="d017" id="d017" class="graf graf--li graf-after--p">Testing iOS WebViews</li><li name="5884" id="5884" class="graf graf--li graf-after--li">Determining Whether Native Methods Are Exposed Through WebViews</li></ul><p name="d972" id="d972" class="graf graf--p graf-after--li">4. Securely communicate with backend servers or is susceptible to man-in-the-middle (MITM) attacks between the server and the mobile application, see also:</p><ul class="postList"><li name="4f05" id="4f05" class="graf graf--li graf-after--p">Testing Network Communication</li><li name="a7d1" id="a7d1" class="graf graf--li graf-after--li">iOS Network APIs</li></ul><p name="35a4" id="35a4" class="graf graf--p graf-after--li">5. Securely stores all local data, or loads untrusted data from storage, see also:</p><ul class="postList"><li name="d5f1" id="d5f1" class="graf graf--li graf-after--p">Data Storage on iOS</li></ul><p name="f41c" id="f41c" class="graf graf--p graf-after--li">6. Protect itself against compromised environments, repackaging or other local attacks, see also:</p><ul class="postList"><li name="68bf" id="68bf" class="graf graf--li graf-after--p">iOS Anti-Reversing Defenses</li></ul><h3 name="f45b" id="f45b" class="graf graf--h3 graf-after--li">Testing Network Communication</h3><p name="4029" id="4029" class="graf graf--p graf-after--h3">Practically every network-connected mobile app uses the Hypertext Transfer Protocol (HTTP) or HTTP over Transport Layer Security (TLS), HTTPS, to send and receive data to and from remote endpoints. Consequently, network-based attacks (such as packet sniffing and man-in-the-middle-attacks) are a problem.</p><h4 name="f5a3" id="f5a3" class="graf graf--h4 graf-after--p">Intercepting HTTP(S) Traffic</h4><p name="431d" id="431d" class="graf graf--p graf-after--h4">In many cases, it is most practical to configure a system proxy on the mobile device, so that HTTP(S) traffic is redirected through an <em class="markup--em markup--p-em">interception proxy</em> running on your host machine. By monitoring the requests between the mobile app client and the backend, you can easily map the available server-side APIs and gain insight into the communication protocol. Additionally, you can replay and manipulate requests to test for server-side vulnerabilities.</p><p name="f6bf" id="f6bf" class="graf graf--p graf-after--p">Several free and commercial proxy tools are available. Here are some of the most popular:</p><ul class="postList"><li name="7aa1" id="7aa1" class="graf graf--li graf-after--p"><a href="https://portswigger.net/burp" data-href="https://portswigger.net/burp" class="markup--anchor markup--li-anchor" rel="noopener noreferrer noopener" target="_blank">Burp Suite</a></li><li name="b0c7" id="b0c7" class="graf graf--li graf-after--li"><a href="https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project" data-href="https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project" class="markup--anchor markup--li-anchor" rel="noopener noreferrer noopener" target="_blank">OWASP ZAP</a></li><li name="588f" id="588f" class="graf graf--li graf-after--li"><a href="https://www.charlesproxy.com/" data-href="https://www.charlesproxy.com/" class="markup--anchor markup--li-anchor" rel="noopener noreferrer noopener" target="_blank">Charles Proxy</a></li></ul><p name="e542" id="e542" class="graf graf--p graf-after--li">Using a proxy breaks SSL certificate verification and the app will usually fail to initiate TLS connections. To work around this issue, you can install your proxy’s CA certificate on the device.</p><p name="55de" id="55de" class="graf graf--p graf-after--p"><a href="https://www.raywenderlich.com/1484288-preventing-man-in-the-middle-attacks-in-ios-with-ssl-pinning#toc-anchor-002" data-href="https://www.raywenderlich.com/1484288-preventing-man-in-the-middle-attacks-in-ios-with-ssl-pinning#toc-anchor-002" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">Preventing Man-in-the-Middle Attacks in iOS with SSL Pinning</strong></a></p><h3 name="c4f5" id="c4f5" class="graf graf--h3 graf-after--p">Testing Local Data Storage</h3><p name="5b66" id="5b66" class="graf graf--p graf-after--h3">As little sensitive data as possible should be saved in permanent local storage. However, in most practical scenarios, at least some user data must be stored. Fortunately, iOS offers secure storage APIs, which allow developers to use the cryptographic hardware available on every iOS device. If these APIs are used correctly, sensitive data and files can be secured via hardware-backed 256-bit AES encryption.</p><h4 name="8b07" id="8b07" class="graf graf--h4 graf-after--p">The Keychain</h4><p name="2089" id="2089" class="graf graf--p graf-after--h4">The iOS Keychain can be used to securely store short, sensitive bits of data, such as encryption keys and session tokens. It is implemented as an SQLite database that can be accessed through the Keychain APIs only.</p><p name="d7d9" id="d7d9" class="graf graf--p graf-after--p">The <a href="https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/02concepts/concepts.html" data-href="https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/02concepts/concepts.html" class="markup--anchor markup--p-anchor" rel="noopener noreferrer noopener" target="_blank">Keychain API</a> includes the following main operations:</p><ul class="postList"><li name="9f95" id="9f95" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">SecItemAdd</code></li><li name="f415" id="f415" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">SecItemUpdate</code></li><li name="422f" id="422f" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">SecItemCopyMatching</code></li><li name="594b" id="594b" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">SecItemDelete</code></li></ul><p name="2ee6" id="2ee6" class="graf graf--p graf-after--li">Data stored in the Keychain is protected via a class structure that is similar to the class structure used for file encryption. Items added to the Keychain are encoded as a binary plist and encrypted with a 128-bit AES per-item key in Galois/Counter Mode (GCM). Note that larger blobs of data aren’t meant to be saved directly in the Keychain-that’s what the Data Protection API is for. You can configure data protection for Keychain items by setting the <code class="markup--code markup--p-code">kSecAttrAccessible</code> key in the call to <code class="markup--code markup--p-code">SecItemAdd</code> or <code class="markup--code markup--p-code">SecItemUpdate</code>.</p><h3 name="5892" id="5892" class="graf graf--h3 graf-after--p">iOS Anti-Reversing Defenses</h3><ol class="postList"><li name="57e7" id="57e7" class="graf graf--li graf-after--h3">Jailbreak Detection</li><li name="cdf2" id="cdf2" class="graf graf--li graf-after--li">Anti-Debugging Checks</li><li name="75e6" id="75e6" class="graf graf--li graf-after--li">File Integrity Checks</li><li name="0e2f" id="0e2f" class="graf graf--li graf-after--li">Device Bindings</li></ol><h3 name="f9b4" id="f9b4" class="graf graf--h3 graf-after--li">1. Jailbreak Detection</h3><h4 name="81e3" id="81e3" class="graf graf--h4 graf-after--h3">File-based Checks</h4><p name="77d3" id="77d3" class="graf graf--p graf-after--h4">Check for files and directories typically associated with jailbreaks, such as:</p><pre name="b3be" id="b3be" class="graf graf--pre graf-after--p">/Applications/Cydia.app</pre><pre name="d4bd" id="d4bd" class="graf graf--pre graf-after--pre">/Applications/FakeCarrier.app</pre><pre name="3164" id="3164" class="graf graf--pre graf-after--pre">/Applications/Icy.app</pre><pre name="6041" id="6041" class="graf graf--pre graf-after--pre">/Applications/IntelliScreen.app</pre><pre name="1160" id="1160" class="graf graf--pre graf-after--pre">/Applications/MxTube.app</pre><pre name="b6f5" id="b6f5" class="graf graf--pre graf-after--pre">/Applications/RockApp.app</pre><pre name="5914" id="5914" class="graf graf--pre graf-after--pre">/Applications/SBSettings.app</pre><pre name="fe8d" id="fe8d" class="graf graf--pre graf-after--pre">/Applications/WinterBoard.app</pre><pre name="7a86" id="7a86" class="graf graf--pre graf-after--pre">/Applications/blackra1n.app</pre><pre name="9c09" id="9c09" class="graf graf--pre graf-after--pre">/Library/MobileSubstrate/DynamicLibraries/LiveClock.plist</pre><pre name="5c4e" id="5c4e" class="graf graf--pre graf-after--pre">/Library/MobileSubstrate/DynamicLibraries/Veency.plist</pre><pre name="bd32" id="bd32" class="graf graf--pre graf-after--pre">/Library/MobileSubstrate/MobileSubstrate.dylib</pre><pre name="b3d6" id="b3d6" class="graf graf--pre graf-after--pre">/System/Library/LaunchDaemons/com.ikey.bbot.plist</pre><pre name="8e77" id="8e77" class="graf graf--pre graf-after--pre">/System/Library/LaunchDaemons/com.saurik.Cydia.Startup.plist</pre><p name="06ef" id="06ef" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">Checking File Permissions</strong></p><p name="1d72" id="1d72" class="graf graf--p graf-after--p">Another way to check for jailbreaking mechanisms is to try to write to a location that’s outside the application’s sandbox. You can do this by having the application attempt to create a file in, for example, the <code class="markup--code markup--p-code">/private directory</code>. If the file is created successfully, the device has been jailbroken.</p><p name="2ef1" id="2ef1" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Checking Protocol Handlers</strong></p><p name="df63" id="df63" class="graf graf--p graf-after--p">You can check protocol handlers by attempting to open a Cydia URL. The Cydia app store, which practically every jailbreaking tool installs by default, installs the cydia:// protocol handler.</p><p name="f199" id="f199" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Calling System APIs</strong></p><p name="6313" id="6313" class="graf graf--p graf-after--p">Calling the <code class="markup--code markup--p-code">system</code> function with a &quot;NULL&quot; argument on a non-jailbroken device will return &quot;0&quot;; doing the same thing on a jailbroken device will return &quot;1&quot;. This difference is due to the function&#39;s checking for access to <code class="markup--code markup--p-code">/bin/sh</code> on jailbroken devices only.</p><h4 name="a468" id="a468" class="graf graf--h4 graf-after--p">Bypassing Jailbreak Detection</h4><p name="3739" id="3739" class="graf graf--p graf-after--h4">Once you start an application that has jailbreak detection enabled on a jailbroken device, you’ll notice one of the following things:</p><ol class="postList"><li name="5a55" id="5a55" class="graf graf--li graf-after--p">The application closes immediately, without any notification.</li></ol><pre name="04fa" id="04fa" class="graf graf--pre graf-after--li">At this point, bypassing jailbreak detection with Cycript is trivial.<br><strong class="markup--strong markup--pre-strong">Note: </strong><br># <strong class="markup--strong markup--pre-strong">Cycript</strong> allows developers to explore and modify running applications on either iOS or Mac OS X using a hybrid of Objective-C++ and JavaScript syntax through an interactive console that features syntax highlighting and tab completion.<br>(It also runs standalone on Android and Linux and provides access to Java, but without injection.)<br><a href="http://www.cycript.org/" data-href="http://www.cycript.org/" class="markup--anchor markup--pre-anchor" rel="noopener" target="_blank">http://www.cycript.org/</a></pre><p name="60de" id="60de" class="graf graf--p graf-after--pre">2. A pop-up window indicates that the application won’t run on a jailbroken device.</p><pre name="d07c" id="d07c" class="graf graf--pre graf-after--p">At this point, Frida that we will use to bypass jailbreak detection is so-called early instrumentation, that is, we will replace function implementation at startup.<br><strong class="markup--strong markup--pre-strong">Note</strong>: <br>#<strong class="markup--strong markup--pre-strong">Frida</strong> Inject JavaScript to explore native apps on Windows, Mac, Linux, iOS, Android, and QNX.<br><a href="https://github.com/frida" data-href="https://github.com/frida" class="markup--anchor markup--pre-anchor" rel="noopener" target="_blank">https://github.com/frida</a></pre><h3 name="646f" id="646f" class="graf graf--h3 graf-after--pre">2. Anti-Debugging Checks</h3><p name="7a45" id="7a45" class="graf graf--p graf-after--h3">Debugging and exploring applications are helpful during reversing. Using a debugger, a reverse engineer can not only track critical variables but also read and modify memory.</p><p name="45e3" id="45e3" class="graf graf--p graf-after--p">There are several anti-debugging techniques; a few of them are discussed below.</p><p name="a42f" id="a42f" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Using ptrace</strong></p><p name="22c5" id="22c5" class="graf graf--p graf-after--p">iOS runs on an XNU kernel. The XNU kernel implements a <code class="markup--code markup--p-code">ptrace</code> system call that&#39;s not as powerful as the Unix and Linux implementations. The XNU kernel exposes another interface via Mach IPC to enable debugging. The iOS implementation of <code class="markup--code markup--p-code">ptrace</code> serves an important function: preventing the debugging of processes. This feature is implemented as the PT_DENY_ATTACH option of the <code class="markup--code markup--p-code">ptrace</code> syscall. Using PT_DENY_ATTACH is a fairly well-known anti-debugging technique, so you may encounter it often during iOS pentests.</p><p name="5cbe" id="5cbe" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Using sysctl</strong></p><p name="4eb1" id="4eb1" class="graf graf--p graf-after--p">Another approach to detecting a debugger that’s attached to the calling process involves <code class="markup--code markup--p-code">sysctl</code>. According to the Apple documentation:</p><pre name="8ee2" id="8ee2" class="graf graf--pre graf-after--p"><em class="markup--em markup--pre-em">The </em><code class="markup--code markup--pre-code"><em class="markup--em markup--pre-em">sysctl</em></code><em class="markup--em markup--pre-em"> function retrieves system information and allows processes with appropriate privileges to set system information.</em></pre><p name="6908" id="6908" class="graf graf--p graf-after--pre"><code class="markup--code markup--p-code">sysctl</code> can also be used to retrieve information about the current process (such as whether the process is being debugged). The following example implementation is discussed in [&quot;How do I determine if I&#39;m being run under the debugger?&quot;](<a href="https://developer.apple.com/library/content/qa/qa1361/_index.html" data-href="https://developer.apple.com/library/content/qa/qa1361/_index.html" class="markup--anchor markup--p-anchor" rel="noopener noreferrer noopener" target="_blank">https://developer.apple.com/library/content/qa/qa1361/_index.html</a> &quot;How do I determine if I&#39;m being run under the debugger?&quot;)</p><h3 name="2349" id="2349" class="graf graf--h3 graf-after--p">3. File Integrity Checks</h3><p name="47e3" id="47e3" class="graf graf--p graf-after--h3">There are two topics related to file integrity:</p><ol class="postList"><li name="23b2" id="23b2" class="graf graf--li graf-after--p"><em class="markup--em markup--li-em">Application source code integrity checks:</em> In the “Tampering and Reverse Engineering” chapter, we discussed the iOS IPA application signature check. We also saw that determined reverse engineers can easily bypass this check by re-packaging and re-signing an app using a developer or enterprise certificate. One way to make this harder is to add an internal run-time check that determines whether the signatures still match at run time.</li><li name="b65f" id="b65f" class="graf graf--li graf-after--li"><em class="markup--em markup--li-em">File storage integrity checks:</em> When files are stored by the application, key-value pairs in the Keychain, <code class="markup--code markup--li-code">UserDefaults</code>/<code class="markup--code markup--li-code">NSUserDefaults</code>, a SQLite database, or a Realm database, their integrity should be protected.</li></ol><p name="b89f" id="b89f" class="graf graf--p graf-after--li">When you generate an HMAC with CC:</p><ol class="postList"><li name="a8e5" id="a8e5" class="graf graf--li graf-after--p">Get the data as <code class="markup--code markup--li-code">NSMutableData</code>.</li><li name="d346" id="d346" class="graf graf--li graf-after--li">Get the data key (from the Keychain if possible).</li><li name="0c8f" id="0c8f" class="graf graf--li graf-after--li">Calculate the hash value.</li><li name="528d" id="528d" class="graf graf--li graf-after--li">Append the hash value to the actual data.</li><li name="fbb3" id="fbb3" class="graf graf--li graf-after--li">Store the results of step 4.</li></ol><pre name="ac55" id="ac55" class="graf graf--pre graf-after--li">// Allocate a buffer to hold the digest and perform the digest.</pre><pre name="b199" id="b199" class="graf graf--pre graf-after--pre">NSMutableData* actualData = [getData];</pre><pre name="b6aa" id="b6aa" class="graf graf--pre graf-after--pre">//get the key from the keychain</pre><pre name="c3af" id="c3af" class="graf graf--pre graf-after--pre">NSData* key = [getKey];</pre><pre name="18a6" id="18a6" class="graf graf--pre graf-after--pre">NSMutableData* digestBuffer = [NSMutableData dataWithLength:CC_SHA256_DIGEST_LENGTH];</pre><pre name="104d" id="104d" class="graf graf--pre graf-after--pre">CCHmac(kCCHmacAlgSHA256, [actualData bytes], (CC_LONG)[key length], [actualData bytes], (CC_LONG)[actualData length], [digestBuffer mutableBytes]);</pre><pre name="fe56" id="fe56" class="graf graf--pre graf-after--pre">[actualData appendData: digestBuffer];</pre><p name="d176" id="d176" class="graf graf--p graf-after--pre">When verifying the HMAC with CC, follow these steps:</p><ol class="postList"><li name="32a4" id="32a4" class="graf graf--li graf-after--p">Extract the message and the hmacbytes as separate <code class="markup--code markup--li-code">NSData</code>.</li><li name="223e" id="223e" class="graf graf--li graf-after--li">Repeat steps 1–3 of the procedure for generating an HMAC on the <code class="markup--code markup--li-code">NSData</code>.</li><li name="77ca" id="77ca" class="graf graf--li graf-after--li">Compare the extracted HMAC bytes to the result of step 1.</li></ol><pre name="a621" id="a621" class="graf graf--pre graf-after--li">NSData* hmac = [data subdataWithRange:NSMakeRange(data.length - CC_SHA256_DIGEST_LENGTH, CC_SHA256_DIGEST_LENGTH)];</pre><pre name="ca4e" id="ca4e" class="graf graf--pre graf-after--pre">NSData* actualData = [data subdataWithRange:NSMakeRange(0, (data.length - hmac.length))];</pre><pre name="b449" id="b449" class="graf graf--pre graf-after--pre">NSMutableData* digestBuffer = [NSMutableData dataWithLength:CC_SHA256_DIGEST_LENGTH];</pre><pre name="518c" id="518c" class="graf graf--pre graf-after--pre">CCHmac(kCCHmacAlgSHA256, [actualData bytes], (CC_LONG)[key length], [actualData bytes], (CC_LONG)[actualData length], [digestBuffer mutableBytes]);</pre><pre name="6d26" id="6d26" class="graf graf--pre graf-after--pre">return [hmac isEqual: digestBuffer];</pre><h3 name="50bf" id="50bf" class="graf graf--h3 graf-after--pre">4. Device Binding</h3><p name="d62a" id="d62a" class="graf graf--p graf-after--h3">The purpose of device binding is to impede an attacker who tries to copy an app and its state from device A to device B and continue the execution of the app on device B. After device A has been determined trusted, it may have more privileges than device B. This situation shouldn’t change when an app is copied from device A to device B.</p><p name="1d27" id="1d27" class="graf graf--p graf-after--p"><a href="https://developer.apple.com/library/content/releasenotes/General/RN-iOSSDK-7.0/index.html" data-href="https://developer.apple.com/library/content/releasenotes/General/RN-iOSSDK-7.0/index.html" class="markup--anchor markup--p-anchor" rel="noopener noreferrer noopener" target="_blank">Since iOS 7.0</a>, hardware identifiers (such as MAC addresses) are off-limits. The ways to bind an application to a device are based on <code class="markup--code markup--p-code">identifierForVendor</code>, storing something in the Keychain, or using Google&#39;s InstanceID for iOS.</p><p name="78dd" id="78dd" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">For more: </strong><a href="https://github.com/pjebs/Obfuscator-iOS" data-href="https://github.com/pjebs/Obfuscator-iOS" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">App Obfuscator for iOS Apps</strong></a></p><h4 name="3c7f" id="3c7f" class="graf graf--h4 graf-after--p"><strong class="markup--strong markup--h4-strong">Previous Article:</strong> <a href="https://medium.com/ios-expert-series-or-interview-series/implementing-dark-mode-in-ios-13-54eb6775a1b7" data-href="https://medium.com/ios-expert-series-or-interview-series/implementing-dark-mode-in-ios-13-54eb6775a1b7" class="markup--anchor markup--h4-anchor" target="_blank">Implementing Dark Mode in iOS 13</a></h4><h4 name="f61c" id="f61c" class="graf graf--h4 graf-after--h4">Next Article: <a href="/ios-expert-series-or-interview-series/sharing-visually-rich-links-linkpresentation-framework-ios-13-d435025f8bfa?source=your_stories_page---------------------------" data-href="/ios-expert-series-or-interview-series/sharing-visually-rich-links-linkpresentation-framework-ios-13-d435025f8bfa?source=your_stories_page---------------------------" class="markup--anchor markup--h4-anchor" rel="noopener" target="_blank">Sharing Visually Rich Links (LinkPresentation Framework)- iOS 13</a></h4><h4 name="3d63" id="3d63" class="graf graf--h4 graf-after--h4">For more articles:</h4><ol class="postList"><li name="732f" id="732f" class="graf graf--li graf-after--h4"><a href="https://medium.com/ios-expert-series-or-interview-series/top-ios-interview-questions-you-must-prepare-in-2018-e0d73be27adc?source=post_page---------------------------" data-href="https://medium.com/ios-expert-series-or-interview-series/top-ios-interview-questions-you-must-prepare-in-2018-e0d73be27adc?source=post_page---------------------------" class="markup--anchor markup--li-anchor" target="_blank">Top IOS Interview Questions and Answers for 2019</a></li></ol><p name="4c79" id="4c79" class="graf graf--p graf-after--li">2. <a href="https://medium.com/ios-expert-series-or-interview-series/ios-interview-questions-for-developers-senior-developers-d75f94ea9bec?source=post_page---------------------------" data-href="https://medium.com/ios-expert-series-or-interview-series/ios-interview-questions-for-developers-senior-developers-d75f94ea9bec?source=post_page---------------------------" class="markup--anchor markup--p-anchor" target="_blank">iOS Interview Questions for Developers/Senior Developers</a></p><p name="0e07" id="0e07" class="graf graf--p graf-after--p">3. <a href="https://medium.com/system-designing-interviews/approach-a-system-design-interview-f3594e243730?source=post_page---------------------------" data-href="https://medium.com/system-designing-interviews/approach-a-system-design-interview-f3594e243730?source=post_page---------------------------" class="markup--anchor markup--p-anchor" target="_blank">Approach a System Design Interview</a></p><p name="efe9" id="efe9" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">References</strong>:</p><ol class="postList"><li name="e9f4" id="e9f4" class="graf graf--li graf-after--p"><a href="https://www.coredump.gr/articles/ios-anti-debugging-protections-part-1/" data-href="https://www.coredump.gr/articles/ios-anti-debugging-protections-part-1/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">https://www.coredump.gr/articles/ios-anti-debugging-protections-part-1/</a></li><li name="05c6" id="05c6" class="graf graf--li graf-after--li"><a href="https://www.coredump.gr/articles/ios-anti-debugging-protections-part-2/" data-href="https://www.coredump.gr/articles/ios-anti-debugging-protections-part-2/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">https://www.coredump.gr/articles/ios-anti-debugging-protections-part-2/</a></li><li name="6e93" id="6e93" class="graf graf--li graf-after--li graf--trailing"><a href="https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06j-testing-resiliency-against-reverse-engineering" data-href="https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06j-testing-resiliency-against-reverse-engineering" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06j-testing-resiliency-against-reverse-engineering</a></li></ol></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@nishantnitb" class="p-author h-card">Nishant Sharma</a> on <a href="https://medium.com/p/65af1d0f3e09"><time class="dt-published" datetime="2019-09-09T13:41:47.049Z">September 9, 2019</time></a>.</p><p><a href="https://medium.com/@nishantnitb/ios-app-security-65af1d0f3e09" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on February 11, 2021.</p></footer></article></body></html>